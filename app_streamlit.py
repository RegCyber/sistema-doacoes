import streamlit as st
import pandas as pd
from datetime import datetime
from database import get_session, Doador, Receptor, Pet, ItemDoacao, Usuario
from database import hash_senha, gerar_salt, verificar_senha

# Configura√ß√£o da p√°gina
st.set_page_config(
    page_title="Sistema de Doa√ß√µes para Enchentes",
    page_icon="ü§ù",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSS personalizado
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 2rem;
        font-weight: bold;
    }
    .metric-card {
        background-color: #f0f2f6;
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
        margin: 0.5rem;
        border: 1px solid #e0e0e0;
    }
    .success-msg {
        background-color: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #28a745;
    }
    .error-msg {
        background-color: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #dc3545;
    }
    .info-msg {
        background-color: #d1ecf1;
        color: #0c5460;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #17a2b8;
    }
    .form-section {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin: 1rem 0;
        border: 1px solid #e0e0e0;
    }
    .stButton button {
        background-color: #1f77b4;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        font-weight: bold;
    }
    .stButton button:hover {
        background-color: #1668a1;
    }
    /* Garantir que a p√°gina sempre comece no topo */
    html {
        scroll-behavior: smooth;
    }
</style>
""", unsafe_allow_html=True)

# Sistema de autentica√ß√£o
def inicializar_sessao():
    if 'usuario_logado' not in st.session_state:
        st.session_state.usuario_logado = None
    if 'is_admin' not in st.session_state:
        st.session_state.is_admin = False
    if 'user_id' not in st.session_state:
        st.session_state.user_id = None
    if 'num_itens_doacao' not in st.session_state:
        st.session_state.num_itens_doacao = 1
    if 'pagina_atual' not in st.session_state:
        st.session_state.pagina_atual = "In√≠cio"
    if 'scroll_position' not in st.session_state:
        st.session_state.scroll_position = 0

def fazer_login(login, senha):
    session = get_session()
    try:
        usuario = session.query(Usuario).filter(Usuario.login == login).first()
        if usuario and verificar_senha(senha, usuario.salt, usuario.senha_hash):
            st.session_state.usuario_logado = usuario.login
            st.session_state.is_admin = usuario.is_admin
            st.session_state.user_id = usuario.id
            return True
        return False
    finally:
        session.close()

def fazer_logout():
    st.session_state.usuario_logado = None
    st.session_state.is_admin = False
    st.session_state.user_id = None
    st.session_state.num_itens_doacao = 1
    st.session_state.pagina_atual = "In√≠cio"

def cadastrar_usuario(login, email, whatsapp, senha):
    session = get_session()
    try:
        # Verificar se usu√°rio j√° existe
        existe = session.query(Usuario).filter(Usuario.login == login).first()
        if existe:
            return False, "Usu√°rio j√° existe"
        
        if len(senha) < 6:
            return False, "Senha deve ter no m√≠nimo 6 caracteres"
        
        salt = gerar_salt()
        senha_hash = hash_senha(senha, salt)
        
        novo_usuario = Usuario(
            login=login,
            email=email,
            whatsapp=whatsapp,
            senha_hash=senha_hash,
            salt=salt
        )
        
        session.add(novo_usuario)
        session.commit()
        return True, "Usu√°rio cadastrado com sucesso!"
        
    except Exception as e:
        session.rollback()
        return False, f"Erro ao cadastrar: {e}"
    finally:
        session.close()

# Inicializar sess√£o
inicializar_sessao()

# Sidebar
st.sidebar.title("Navega√ß√£o")

if st.session_state.usuario_logado:
    st.sidebar.success(f"Logado como: {st.session_state.usuario_logado}")
    if st.session_state.is_admin:
        st.sidebar.info("Modo Administrador")
    if st.sidebar.button("Sair"):
        fazer_logout()
        st.rerun()
else:
    opcao_login = st.sidebar.radio("Acesso:", ["Entrar", "Cadastrar"])
    
    if opcao_login == "Entrar":
        with st.sidebar:
            st.subheader("Login")
            login = st.text_input("Usu√°rio")
            senha = st.text_input("Senha", type="password")
            if st.button("Entrar"):
                if fazer_login(login, senha):
                    st.success("Login realizado!")
                    st.rerun()
                else:
                    st.error("Usu√°rio ou senha inv√°lidos")
    
    else:
        with st.sidebar:
            st.subheader("Cadastro")
            login = st.text_input("Nome de usu√°rio")
            email = st.text_input("E-mail")
            whatsapp = st.text_input("WhatsApp")
            senha = st.text_input("Senha", type="password")
            if st.button("Cadastrar"):
                sucesso, mensagem = cadastrar_usuario(login, email, whatsapp, senha)
                if sucesso:
                    st.success(mensagem)
                else:
                    st.error(mensagem)

# JavaScript para rolar para o topo quando mudar de p√°gina
st.markdown("""
<script>
    // Fun√ß√£o para rolar para o topo
    function scrollToTop() {
        window.scrollTo(0, 0);
    }
    
    // Executar quando a p√°gina carregar
    window.addEventListener('load', function() {
        scrollToTop();
    });
</script>
""", unsafe_allow_html=True)

# Controle de navega√ß√£o
if st.session_state.usuario_logado:
    paginas = ["In√≠cio", "Cadastrar Doa√ß√£o", "Solicitar Ajuda", "Pets Perdidos", "Visualizar Cadastros"]
    if st.session_state.is_admin:
        paginas.append("Administra√ß√£o")
else:
    paginas = ["In√≠cio", "Visualizar Cadastros"]
    st.sidebar.warning("Fa√ßa login para cadastrar doa√ß√µes")

# Sele√ß√£o de p√°gina com controle de estado
pagina_selecionada = st.sidebar.selectbox("Selecione a p√°gina:", paginas, index=0)

# Verificar se a p√°gina mudou
if pagina_selecionada != st.session_state.pagina_atual:
    st.session_state.pagina_atual = pagina_selecionada
    # For√ßar rolagem para o topo
    st.markdown("""
    <script>
        window.scrollTo(0, 0);
    </script>
    """, unsafe_allow_html=True)
    st.rerun()

# P√°ginas principais
if not st.session_state.usuario_logado:
    st.title("Sistema de Doa√ß√µes para Enchentes")
    st.info("Fa√ßa login na sidebar para acessar o sistema completo.")
    
else:
    # Sess√£o do banco
    session = get_session()

    # P√°gina Inicial
    if st.session_state.pagina_atual == "In√≠cio":
        st.markdown('<h1 class="main-header">Solidariedade em Tempos de Enchente</h1>', unsafe_allow_html=True)
        
        st.write("""
        ## Juntos somos mais fortes!
        
        Esta plataforma conecta pessoas que querem ajudar com quem precisa de ajuda durante enchentes. 
        Sua solidariedade pode fazer a diferen√ßa!
        """)
        
        # M√©tricas
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            total_doadores = session.query(Doador).count()
            st.metric("Doadores", total_doadores)
        
        with col2:
            total_itens = session.query(ItemDoacao).count()
            st.metric("Itens", total_itens)
        
        with col3:
            total_receptores = session.query(Receptor).count()
            st.metric("Solicita√ß√µes", total_receptores)
        
        with col4:
            total_pets = session.query(Pet).count()
            st.metric("Pets", total_pets)

    # Cadastrar Doa√ß√£o
    elif st.session_state.pagina_atual == "Cadastrar Doa√ß√£o":
        st.title("Cadastrar Doa√ß√£o")
        
        with st.form("form_doador"):
            st.subheader("Dados Pessoais")
            col1, col2 = st.columns(2)
            
            with col1:
                cpf = st.text_input("CPF*", placeholder="000.000.000-00")
                nome = st.text_input("Nome Completo*")
                telefone = st.text_input("Telefone*", placeholder="(11) 99999-9999")
            
            with col2:
                whatsapp = st.text_input("WhatsApp*", placeholder="(11) 99999-9999")
                pode_entregar = st.selectbox("Pode entregar os itens?*", ["", "Sim", "N√£o"])
            
            st.subheader("Endere√ßo")
            col1, col2 = st.columns(2)
            
            with col1:
                cep = st.text_input("CEP*", placeholder="00000-000")
                endereco = st.text_input("Endere√ßo*")
                numero = st.text_input("N√∫mero*")
            
            with col2:
                bairro = st.text_input("Bairro*")
                cidade = st.text_input("Cidade*")
                estado = st.text_input("Estado*", placeholder="SP", max_chars=2)
            
            st.subheader("Itens para Doa√ß√£o")
            num_itens = st.number_input("Quantos itens deseja cadastrar?", min_value=1, max_value=5, value=st.session_state.num_itens_doacao)
            
            itens_data = []
            for i in range(num_itens):
                st.write(f"**Item {i+1}**")
                col1, col2 = st.columns(2)
                
                with col1:
                    item = st.text_input(f"Item*", key=f"item_{i}", 
                                       placeholder="Ex: Arroz, Roupas, Colch√£o...")
                with col2:
                    quantidade = st.number_input(f"Quantidade*", min_value=1, value=1, key=f"qtd_{i}")
                
                descricao = st.text_area(f"Descri√ß√£o", key=f"desc_{i}", 
                                       placeholder="Detalhes do item...",
                                       height=60)
                
                itens_data.append({
                    'item': item,
                    'quantidade': quantidade,
                    'descricao': descricao
                })
            
            st.subheader("Disponibilidade")
            prazo_disponibilidade = st.date_input("Prazo de Disponibilidade*", min_value=datetime.today())
            
            submitted = st.form_submit_button("Cadastrar Doa√ß√£o")
            
            if submitted:
                # Valida√ß√µes
                campos_pessoais_ok = all([cpf, nome, telefone, whatsapp, pode_entregar, 
                                        cep, endereco, numero, bairro, cidade, estado])
                
                # Verifica se h√° pelo menos 1 item preenchido
                itens_validos = [item for item in itens_data if item['item'].strip()]
                if not itens_validos:
                    st.error("Adicione pelo menos um item para doa√ß√£o!")
                    campos_pessoais_ok = False
                
                if campos_pessoais_ok:
                    try:
                        # VERIFICAR SE CPF J√Å EXISTE
                        doador_existente = session.query(Doador).filter(Doador.cpf == cpf).first()
                        if doador_existente:
                            st.error("J√° existe um doador cadastrado com este CPF!")
                            st.info(f"CPF {cpf} j√° pertence a: {doador_existente.nome}")
                        else:
                            # Obter usu√°rio logado
                            usuario_id = st.session_state.user_id
                            
                            # Cadastra o doador
                            novo_doador = Doador(
                                usuario_id=usuario_id,
                                cpf=cpf,
                                nome=nome,
                                endereco=endereco,
                                numero=numero,
                                cep=cep,
                                bairro=bairro,
                                cidade=cidade,
                                estado=estado,
                                telefone=telefone,
                                whatsapp=whatsapp,
                                pode_entregar=pode_entregar == "Sim",
                                prazo_disponibilidade=prazo_disponibilidade
                            )
                            session.add(novo_doador)
                            session.flush()
                            
                            # Cadastra os itens
                            for item_data in itens_validos:
                                novo_item = ItemDoacao(
                                    doador_id=novo_doador.id,
                                    item=item_data['item'],
                                    quantidade=item_data['quantidade'],
                                    descricao=item_data['descricao'].strip() if item_data['descricao'].strip() else None
                                )
                                session.add(novo_item)
                            
                            session.commit()
                            
                            st.success("Doa√ß√£o cadastrada com sucesso!")
                            
                            # Mostra resumo final
                            st.info(f"""
                            **Resumo do cadastro:**
                            - **Doador:** {nome}
                            - **Itens cadastrados:** {len(itens_validos)}
                            - **Quantidade total:** {sum(item['quantidade'] for item in itens_validos)}
                            - **Dispon√≠vel at√©:** {prazo_disponibilidade.strftime('%d/%m/%Y')}
                            """)
                            
                    except Exception as e:
                        session.rollback()
                        st.error(f"Erro ao cadastrar doa√ß√£o: {e}")
                else:
                    st.error("Preencha todos os campos obrigat√≥rios!")

    # Solicitar Ajuda
    elif st.session_state.pagina_atual == "Solicitar Ajuda":
        st.title("Solicitar Ajuda")
        
        with st.form("form_receptor"):
            st.subheader("Dados Pessoais")
            col1, col2 = st.columns(2)
            
            with col1:
                cpf = st.text_input("CPF*", placeholder="000.000.000-00")
                nome = st.text_input("Nome Completo*")
                telefone = st.text_input("Telefone*", placeholder="(11) 99999-9999")
            
            with col2:
                whatsapp = st.text_input("WhatsApp*", placeholder="(11) 99999-9999")
                qtde_pessoas = st.number_input("Quantidade de Pessoas*", min_value=1, value=1)
                pode_retirar = st.selectbox("Pode retirar os itens?*", ["", "Sim", "N√£o"])
            
            st.subheader("Endere√ßo para Entrega")
            col1, col2 = st.columns(2)
            
            with col1:
                cep = st.text_input("CEP*", placeholder="00000-000")
                endereco = st.text_input("Endere√ßo*")
                numero = st.text_input("N√∫mero*")
            
            with col2:
                bairro = st.text_input("Bairro*")
                cidade = st.text_input("Cidade*")
                estado = st.text_input("Estado*", placeholder="SP", max_chars=2)
            
            submitted = st.form_submit_button("Solicitar Ajuda")
            
            if submitted:
                campos_ok = all([cpf, nome, telefone, whatsapp, cep, endereco, numero, bairro, cidade, estado, pode_retirar])
                
                if campos_ok:
                    try:
                        # VERIFICAR SE CPF J√Å EXISTE
                        receptor_existente = session.query(Receptor).filter(Receptor.cpf == cpf).first()
                        if receptor_existente:
                            st.error("J√° existe uma solicita√ß√£o cadastrada com este CPF!")
                            st.info(f"CPF {cpf} j√° pertence a: {receptor_existente.nome}")
                        else:
                            usuario_id = st.session_state.user_id
                            
                            novo_receptor = Receptor(
                                usuario_id=usuario_id,
                                cpf=cpf,
                                nome=nome,
                                endereco=endereco,
                                numero=numero,
                                cep=cep,
                                bairro=bairro,
                                cidade=cidade,
                                estado=estado,
                                telefone=telefone,
                                whatsapp=whatsapp,
                                qtde_pessoas=qtde_pessoas,
                                pode_retirar=pode_retirar == "Sim"
                            )
                            
                            session.add(novo_receptor)
                            session.commit()
                            
                            st.success("Solicita√ß√£o de ajuda cadastrada com sucesso!")
                            
                            st.info(f"""
                            **Resumo do cadastro:**
                            - **Solicitante:** {nome}
                            - **Pessoas na fam√≠lia:** {qtde_pessoas}
                            - **Pode retirar:** {pode_retirar}
                            - **Entregar em:** {endereco}, {numero} - {bairro}, {cidade}-{estado}
                            """)
                            
                    except Exception as e:
                        session.rollback()
                        st.error(f"Erro ao cadastrar solicita√ß√£o: {e}")
                else:
                    st.error("Preencha todos os campos obrigat√≥rios!")

    # Pets Perdidos
    elif st.session_state.pagina_atual == "Pets Perdidos":
        st.title("Pets Perdidos/Encontrados")
        
        tab1, tab2 = st.tabs(["Cadastrar Pet", "Ver Pets"])
        
        with tab1:
            with st.form("form_pet"):
                st.subheader("Dados do Pet")
                col1, col2 = st.columns(2)
                
                with col1:
                    nome = st.text_input("Nome do Pet", placeholder="Opcional")
                    especie = st.selectbox("Esp√©cie*", ["", "Cachorro", "Gato", "Ave", "Outro"])
                    raca = st.text_input("Ra√ßa", placeholder="Opcional")
                
                with col2:
                    situacao = st.selectbox("Situa√ß√£o*", ["", "Perdido", "Encontrado", "Para Ado√ß√£o"])
                    local_encontro = st.text_input("Local onde foi encontrado/perdido*")
                    contato = st.text_input("Contato para informa√ß√µes*", placeholder="Telefone/WhatsApp")
                
                descricao = st.text_area("Descri√ß√£o do Pet*", 
                                       placeholder="Cor, tamanho, caracter√≠sticas especiais...")
                
                submitted = st.form_submit_button("Cadastrar Pet")
                
                if submitted:
                    campos_ok = all([especie, descricao, local_encontro, contato, situacao])
                    
                    if campos_ok:
                        try:
                            usuario_id = st.session_state.user_id
                            
                            novo_pet = Pet(
                                usuario_id=usuario_id,
                                nome=nome if nome else None,
                                especie=especie,
                                raca=raca if raca else None,
                                descricao=descricao,
                                situacao=situacao,
                                local_encontro=local_encontro,
                                contato=contato
                            )
                            
                            session.add(novo_pet)
                            session.commit()
                            
                            st.success("Pet cadastrado com sucesso!")
                            
                        except Exception as e:
                            session.rollback()
                            st.error(f"Erro ao cadastrar pet: {e}")
                    else:
                        st.error("Preencha todos os campos obrigat√≥rios!")
        
        with tab2:
            st.subheader("Pets Cadastrados")
            pets = session.query(Pet).all()
            
            if not pets:
                st.info("Nenhum pet cadastrado ainda.")
            else:
                for pet in pets:
                    st.write(f"**{pet.nome if pet.nome else 'Sem nome'}**")
                    st.write(f"**Esp√©cie:** {pet.especie} | **Ra√ßa:** {pet.raca if pet.raca else 'N√£o informada'}")
                    st.write(f"**Situa√ß√£o:** {pet.situacao} | **Local:** {pet.local_encontro}")
                    st.write(f"**Descri√ß√£o:** {pet.descricao}")
                    st.write(f"**Contato:** {pet.contato}")
                    st.write(f"**Cadastrado em:** {pet.data_cadastro.strftime('%d/%m/%Y %H:%M')}")
                    st.divider()

    # Visualizar Cadastros
    elif st.session_state.pagina_atual == "Visualizar Cadastros":
        st.title("Visualizar Cadastros")
        
        tab1, tab2, tab3 = st.tabs(["Doa√ß√µes", "Solicita√ß√µes", "Pets"])
        
        with tab1:
            st.subheader("Doa√ß√µes Cadastradas")
            doadores = session.query(Doador).all()
            
            if not doadores:
                st.info("Nenhuma doa√ß√£o cadastrada ainda.")
            else:
                for doador in doadores:
                    with st.expander(f"{doador.nome} - {doador.cidade}/{doador.estado}", expanded=False):
                        col1, col2 = st.columns(2)
                        
                        with col1:
                            st.write(f"**CPF:** {doador.cpf}")
                            st.write(f"**Telefone:** {doador.telefone}")
                            st.write(f"**WhatsApp:** {doador.whatsapp}")
                            st.write(f"**Pode entregar:** {'Sim' if doador.pode_entregar else 'N√£o'}")
                            st.write(f"**Dispon√≠vel at√©:** {doador.prazo_disponibilidade.strftime('%d/%m/%Y')}")
                        
                        with col2:
                            st.write(f"**Endere√ßo:** {doador.endereco}, {doador.numero}")
                            st.write(f"**Bairro:** {doador.bairro}")
                            st.write(f"**Cidade/Estado:** {doador.cidade}/{doador.estado}")
                        
                        if doador.itens:
                            st.write("**Itens para doa√ß√£o:**")
                            for item in doador.itens:
                                st.write(f"‚Ä¢ {item.quantidade}x {item.item}" + 
                                       (f" - {item.descricao}" if item.descricao else ""))
        
        with tab2:
            st.subheader("Solicita√ß√µes de Ajuda")
            receptores = session.query(Receptor).all()
            
            if not receptores:
                st.info("Nenhuma solicita√ß√£o de ajuda cadastrada ainda.")
            else:
                for receptor in receptores:
                    with st.expander(f"{receptor.nome} - {receptor.cidade}/{receptor.estado}", expanded=False):
                        col1, col2 = st.columns(2)
                        
                        with col1:
                            st.write(f"**CPF:** {receptor.cpf}")
                            st.write(f"**Telefone:** {receptor.telefone}")
                            st.write(f"**WhatsApp:** {receptor.whatsapp}")
                            st.write(f"**Pessoas na fam√≠lia:** {receptor.qtde_pessoas}")
                            st.write(f"**Pode retirar:** {'Sim' if receptor.pode_retirar else 'N√£o'}")
                        
                        with col2:
                            st.write(f"**Endere√ßo:** {receptor.endereco}, {receptor.numero}")
                            st.write(f"**Bairro:** {receptor.bairro}")
                            st.write(f"**Cidade/Estado:** {receptor.cidade}/{receptor.estado}")
        
        with tab3:
            st.subheader("Pets Cadastrados")
            pets = session.query(Pet).all()
            
            if not pets:
                st.info("Nenhum pet cadastrado ainda.")
            else:
                for pet in pets:
                    with st.expander(f"{pet.nome if pet.nome else 'Sem nome'} - {pet.situacao}", expanded=False):
                        st.write(f"**Esp√©cie:** {pet.especie}")
                        st.write(f"**Ra√ßa:** {pet.raca if pet.raca else 'N√£o informada'}")
                        st.write(f"**Situa√ß√£o:** {pet.situacao}")
                        st.write(f"**Local:** {pet.local_encontro}")
                        st.write(f"**Descri√ß√£o:** {pet.descricao}")
                        st.write(f"**Contato:** {pet.contato}")
                        st.write(f"**Cadastrado em:** {pet.data_cadastro.strftime('%d/%m/%Y %H:%M')}")

    # Administra√ß√£o
    elif st.session_state.pagina_atual == "Administra√ß√£o":
        st.title("√Årea Administrativa")
        
        st.subheader("Estat√≠sticas do Sistema")
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            total_usuarios = session.query(Usuario).count()
            st.metric("Total de Usu√°rios", total_usuarios)
        
        with col2:
            total_doadores = session.query(Doador).count()
            st.metric("Doadores", total_doadores)
        
        with col3:
            total_receptores = session.query(Receptor).count()
            st.metric("Solicitantes", total_receptores)
        
        with col4:
            total_pets = session.query(Pet).count()
            st.metric("Pets", total_pets)

    # Fechar sess√£o
    session.close()